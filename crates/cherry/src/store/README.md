# çŠ¶æ€ç®¡ç†å±‚æ¶æ„æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

çŠ¶æ€ç®¡ç†å±‚ä½¿ç”¨Zustandä½œä¸ºçŠ¶æ€ç®¡ç†åº“ï¼Œè´Ÿè´£ç®¡ç†åº”ç”¨çš„å…¨å±€çŠ¶æ€å’Œä¸šåŠ¡é€»è¾‘ã€‚é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œæ¯ä¸ªåŠŸèƒ½åŸŸå¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„Storeï¼Œæ”¯æŒç±»å‹å®‰å…¨å’Œå¼€å‘å·¥å…·é›†æˆã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### çŠ¶æ€ç®¡ç†æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     State Management                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Auth      â”‚  â”‚  Contact    â”‚  â”‚Conversation â”‚         â”‚
â”‚  â”‚   Store     â”‚  â”‚  Store      â”‚  â”‚  Store      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚Notification â”‚  â”‚ReadPosition â”‚  â”‚   Other     â”‚         â”‚
â”‚  â”‚  Store      â”‚  â”‚  Store      â”‚  â”‚  Stores     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Service   â”‚  â”‚   Actions   â”‚  â”‚   Middleware    â”‚     â”‚
â”‚  â”‚   Layer     â”‚  â”‚  (Methods)  â”‚  â”‚   (DevTools)    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£**: æ¯ä¸ªStoreåªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½åŸŸ
2. **ä¸å¯å˜æ€§**: çŠ¶æ€æ›´æ–°éµå¾ªä¸å¯å˜åŸåˆ™
3. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
4. **å¯æµ‹è¯•æ€§**: æ”¯æŒå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
5. **å¼€å‘å‹å¥½**: é›†æˆRedux DevTools

## ğŸ“ ç›®å½•ç»“æ„

```
store/
â”œâ”€â”€ README.md                 # æœ¬æ–‡æ¡£
â”œâ”€â”€ auth.ts                  # è®¤è¯çŠ¶æ€ç®¡ç†
â”œâ”€â”€ contact.ts               # è”ç³»äººçŠ¶æ€ç®¡ç†
â”œâ”€â”€ conversation.ts          # ä¼šè¯çŠ¶æ€ç®¡ç†
â”œâ”€â”€ notification.ts          # é€šçŸ¥çŠ¶æ€ç®¡ç†
â”œâ”€â”€ readPosition.ts          # é˜…è¯»ä½ç½®çŠ¶æ€ç®¡ç†
â””â”€â”€ index.ts                 # ç»Ÿä¸€å¯¼å‡ºå…¥å£
```

## ğŸ”§ Storeè§„èŒƒ

### æ ‡å‡†Storeç»“æ„

```typescript
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';
import { persist } from 'zustand/middleware';
import type { StoreState, StoreActions } from '@/types';

// çŠ¶æ€æ¥å£
interface StoreState {
  // çŠ¶æ€å®šä¹‰
  data: DataType[];
  loading: boolean;
  error: string | null;
}

// æ“ä½œæ¥å£
interface StoreActions {
  // æ“ä½œæ–¹æ³•
  fetchData: () => Promise<void>;
  addData: (item: DataType) => void;
  updateData: (id: string, updates: Partial<DataType>) => void;
  deleteData: (id: string) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
}

// Storeç±»å‹
type Store = StoreState & StoreActions;

// åˆå§‹çŠ¶æ€
const initialState: StoreState = {
  data: [],
  loading: false,
  error: null,
};

// åˆ›å»ºStore
export const useStore = create<Store>()(
  devtools(
    persist(
      (set, get) => ({
        ...initialState,
        
        // æ“ä½œæ–¹æ³•å®ç°
        fetchData: async () => {
          set({ loading: true, error: null });
          try {
            const data = await service.fetchData();
            set({ data, loading: false });
          } catch (error) {
            set({ 
              error: error.message, 
              loading: false 
            });
          }
        },
        
        addData: (item) => {
          set((state) => ({
            data: [...state.data, item]
          }));
        },
        
        updateData: (id, updates) => {
          set((state) => ({
            data: state.data.map(item =>
              item.id === id ? { ...item, ...updates } : item
            )
          }));
        },
        
        deleteData: (id) => {
          set((state) => ({
            data: state.data.filter(item => item.id !== id)
          }));
        },
        
        setLoading: (loading) => {
          set({ loading });
        },
        
        setError: (error) => {
          set({ error });
        },
      }),
      {
        name: 'store-name', // æŒä¹…åŒ–é”®å
        partialize: (state) => ({
          // åªæŒä¹…åŒ–ç‰¹å®šå­—æ®µ
          data: state.data,
        }),
      }
    ),
    {
      name: 'StoreName', // DevToolsæ˜¾ç¤ºåç§°
    }
  )
);
```

### çŠ¶æ€é€‰æ‹©å™¨

```typescript
// åŸºç¡€é€‰æ‹©å™¨
export const useData = () => useStore((state) => state.data);
export const useLoading = () => useStore((state) => state.loading);
export const useError = () => useStore((state) => state.error);

// æ´¾ç”Ÿé€‰æ‹©å™¨
export const useDataById = (id: string) => 
  useStore((state) => state.data.find(item => item.id === id));

export const useDataCount = () => 
  useStore((state) => state.data.length);

// ç»„åˆé€‰æ‹©å™¨
export const useDataWithLoading = () => 
  useStore((state) => ({
    data: state.data,
    loading: state.loading,
    error: state.error,
  }));
```

## ğŸ“Š Storeè¯¦æƒ…

### AuthStore - è®¤è¯çŠ¶æ€

**èŒè´£**: ç®¡ç†ç”¨æˆ·è®¤è¯çŠ¶æ€ã€Tokenã€ç”¨æˆ·ä¿¡æ¯

**çŠ¶æ€**:
```typescript
interface AuthState {
  user: User | null;
  token: string | null;
  refreshToken: string | null;
  isAuthenticated: boolean;
  loading: boolean;
  error: string | null;
}
```

**æ“ä½œ**:
```typescript
interface AuthActions {
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
  refreshToken: () => Promise<void>;
  setUser: (user: User) => void;
  setToken: (token: string) => void;
  clearError: () => void;
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const { user, isAuthenticated, login, logout } = useAuthStore();

// ç™»å½•
await login('user@example.com', 'password');

// æ£€æŸ¥è®¤è¯çŠ¶æ€
if (isAuthenticated) {
  console.log('User:', user);
}

// ç™»å‡º
logout();
```

### ContactStore - è”ç³»äººçŠ¶æ€

**èŒè´£**: ç®¡ç†è”ç³»äººåˆ—è¡¨ã€ç¾¤ç»„ã€æœç´¢çŠ¶æ€

**çŠ¶æ€**:
```typescript
interface ContactState {
  contacts: Contact[];
  groups: Group[];
  searchQuery: string;
  searchResults: Contact[];
  loading: boolean;
  error: string | null;
}
```

**æ“ä½œ**:
```typescript
interface ContactActions {
  fetchContacts: () => Promise<void>;
  searchContacts: (query: string) => Promise<void>;
  createGroup: (groupData: GroupData) => Promise<void>;
  joinGroup: (groupId: string) => Promise<void>;
  leaveGroup: (groupId: string) => Promise<void>;
  setSearchQuery: (query: string) => void;
  clearSearch: () => void;
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const { 
  contacts, 
  groups, 
  searchContacts, 
  createGroup 
} = useContactStore();

// æœç´¢è”ç³»äºº
await searchContacts('john');

// åˆ›å»ºç¾¤ç»„
await createGroup({
  name: 'My Group',
  members: ['user1', 'user2']
});
```

### ConversationStore - ä¼šè¯çŠ¶æ€

**èŒè´£**: ç®¡ç†ä¼šè¯åˆ—è¡¨ã€å½“å‰ä¼šè¯ã€æ¶ˆæ¯çŠ¶æ€

**çŠ¶æ€**:
```typescript
interface ConversationState {
  conversations: Conversation[];
  currentConversation: Conversation | null;
  messages: Message[];
  loading: boolean;
  error: string | null;
}
```

**æ“ä½œ**:
```typescript
interface ConversationActions {
  fetchConversations: () => Promise<void>;
  selectConversation: (conversationId: string) => void;
  loadMessages: (conversationId: string) => Promise<void>;
  sendMessage: (content: string, type?: string) => Promise<void>;
  addMessage: (message: Message) => void;
  updateMessageStatus: (messageId: string, status: MessageStatus) => void;
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const { 
  conversations, 
  currentConversation, 
  messages,
  selectConversation,
  sendMessage 
} = useConversationStore();

// é€‰æ‹©ä¼šè¯
selectConversation('conv-123');

// å‘é€æ¶ˆæ¯
await sendMessage('Hello World');
```

### NotificationStore - é€šçŸ¥çŠ¶æ€

**èŒè´£**: ç®¡ç†é€šçŸ¥åˆ—è¡¨ã€æœªè¯»æ•°é‡ã€é€šçŸ¥è®¾ç½®

**çŠ¶æ€**:
```typescript
interface NotificationState {
  notifications: Notification[];
  unreadCount: number;
  settings: NotificationSettings;
  loading: boolean;
}
```

**æ“ä½œ**:
```typescript
interface NotificationActions {
  addNotification: (notification: Notification) => void;
  markAsRead: (notificationId: string) => void;
  markAllAsRead: () => void;
  clearNotifications: () => void;
  updateSettings: (settings: Partial<NotificationSettings>) => void;
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const { 
  notifications, 
  unreadCount, 
  addNotification,
  markAsRead 
} = useNotificationStore();

// æ·»åŠ é€šçŸ¥
addNotification({
  id: 'notif-1',
  title: 'New Message',
  message: 'You have a new message',
  type: 'info'
});

// æ ‡è®°ä¸ºå·²è¯»
markAsRead('notif-1');
```

### ReadPositionStore - é˜…è¯»ä½ç½®çŠ¶æ€

**èŒè´£**: ç®¡ç†æ¶ˆæ¯é˜…è¯»ä½ç½®ã€æ»šåŠ¨ä½ç½®

**çŠ¶æ€**:
```typescript
interface ReadPositionState {
  positions: Record<string, number>; // conversationId -> messageId
  scrollPositions: Record<string, number>; // conversationId -> scrollTop
}
```

**æ“ä½œ**:
```typescript
interface ReadPositionActions {
  setReadPosition: (conversationId: string, messageId: number) => void;
  getReadPosition: (conversationId: string) => number;
  setScrollPosition: (conversationId: string, scrollTop: number) => void;
  getScrollPosition: (conversationId: string) => number;
  clearPositions: (conversationId?: string) => void;
}
```

## ğŸ”„ çŠ¶æ€æ›´æ–°æ¨¡å¼

### å¼‚æ­¥æ“ä½œæ¨¡å¼

```typescript
// å¼‚æ­¥æ“ä½œæ¨¡æ¿
const asyncAction = async (params: any) => {
  set({ loading: true, error: null });
  try {
    const result = await service.action(params);
    set({ data: result, loading: false });
  } catch (error) {
    set({ 
      error: error.message, 
      loading: false 
    });
  }
};
```

### ä¹è§‚æ›´æ–°æ¨¡å¼

```typescript
// ä¹è§‚æ›´æ–°æ¨¡æ¿
const optimisticUpdate = (id: string, updates: any) => {
  // ç«‹å³æ›´æ–°UI
  set((state) => ({
    data: state.data.map(item =>
      item.id === id ? { ...item, ...updates } : item
    )
  }));
  
  // å¼‚æ­¥åŒæ­¥åˆ°æœåŠ¡å™¨
  service.update(id, updates).catch((error) => {
    // å›æ»šæ›´æ–°
    set((state) => ({
      data: state.data.map(item =>
        item.id === id ? { ...item, ...originalData } : item
      ),
      error: error.message
    }));
  });
};
```

### æ‰¹é‡æ›´æ–°æ¨¡å¼

```typescript
// æ‰¹é‡æ›´æ–°æ¨¡æ¿
const batchUpdate = (updates: Update[]) => {
  set((state) => {
    const newData = [...state.data];
    updates.forEach(({ id, changes }) => {
      const index = newData.findIndex(item => item.id === id);
      if (index !== -1) {
        newData[index] = { ...newData[index], ...changes };
      }
    });
    return { data: newData };
  });
};
```

## ğŸ› ï¸ å¼€å‘æŒ‡å—

### åˆ›å»ºæ–°Store

1. **åˆ›å»ºStoreæ–‡ä»¶**:
```bash
touch src/store/newStore.ts
```

2. **å®šä¹‰çŠ¶æ€æ¥å£**:
```typescript
interface NewStoreState {
  data: DataType[];
  loading: boolean;
  error: string | null;
}
```

3. **å®šä¹‰æ“ä½œæ¥å£**:
```typescript
interface NewStoreActions {
  fetchData: () => Promise<void>;
  addData: (item: DataType) => void;
  updateData: (id: string, updates: Partial<DataType>) => void;
  deleteData: (id: string) => void;
}
```

4. **å®ç°Store**:
```typescript
export const useNewStore = create<NewStoreState & NewStoreActions>()(
  devtools(
    persist(
      (set, get) => ({
        data: [],
        loading: false,
        error: null,
        
        fetchData: async () => {
          set({ loading: true });
          try {
            const data = await service.fetchData();
            set({ data, loading: false });
          } catch (error) {
            set({ error: error.message, loading: false });
          }
        },
        
        addData: (item) => {
          set((state) => ({
            data: [...state.data, item]
          }));
        },
        
        updateData: (id, updates) => {
          set((state) => ({
            data: state.data.map(item =>
              item.id === id ? { ...item, ...updates } : item
            )
          }));
        },
        
        deleteData: (id) => {
          set((state) => ({
            data: state.data.filter(item => item.id !== id)
          }));
        },
      }),
      {
        name: 'new-store',
      }
    ),
    {
      name: 'NewStore',
    }
  )
);
```

5. **åˆ›å»ºé€‰æ‹©å™¨**:
```typescript
export const useNewData = () => useNewStore((state) => state.data);
export const useNewLoading = () => useNewStore((state) => state.loading);
export const useNewError = () => useNewStore((state) => state.error);
```

### Storeæµ‹è¯•

```typescript
import { renderHook, act } from '@testing-library/react';
import { useNewStore } from './newStore';

describe('NewStore', () => {
  beforeEach(() => {
    // é‡ç½®StoreçŠ¶æ€
    useNewStore.setState({
      data: [],
      loading: false,
      error: null,
    });
  });

  it('should add data', () => {
    const { result } = renderHook(() => useNewStore());
    
    act(() => {
      result.current.addData({ id: '1', name: 'Test' });
    });
    
    expect(result.current.data).toHaveLength(1);
    expect(result.current.data[0].name).toBe('Test');
  });

  it('should handle async operations', async () => {
    const { result } = renderHook(() => useNewStore());
    
    await act(async () => {
      await result.current.fetchData();
    });
    
    expect(result.current.loading).toBe(false);
  });
});
```

### æ€§èƒ½ä¼˜åŒ–

```typescript
// ä½¿ç”¨æµ…æ¯”è¾ƒä¼˜åŒ–æ¸²æŸ“
export const useOptimizedData = () => 
  useStore(
    (state) => state.data,
    (prev, next) => prev.length === next.length
  );

// ä½¿ç”¨useMemoç¼“å­˜æ´¾ç”ŸçŠ¶æ€
export const useFilteredData = (filter: string) => {
  const data = useStore((state) => state.data);
  return useMemo(() => 
    data.filter(item => item.name.includes(filter)),
    [data, filter]
  );
};
```

## ğŸ”® æ‰©å±•æ€§

### ä¸­é—´ä»¶ç³»ç»Ÿ
- æ—¥å¿—ä¸­é—´ä»¶
- æŒä¹…åŒ–ä¸­é—´ä»¶
- åŒæ­¥ä¸­é—´ä»¶

### æ’ä»¶ç³»ç»Ÿ
- è‡ªå®šä¹‰ä¸­é—´ä»¶
- çŠ¶æ€ç›‘å¬å™¨
- å¼€å‘å·¥å…·æ’ä»¶

### çŠ¶æ€åŒæ­¥
- è·¨æ ‡ç­¾é¡µåŒæ­¥
- æœåŠ¡ç«¯åŒæ­¥
- ç¦»çº¿åŒæ­¥

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-07-13  
**ç»´æŠ¤è€…**: Cherry Team 